# Настройка OAuth 2.0 для авторизации через VK ID

## НАСТРОЙКА

### На стороне VK:
1. **Создание приложения в VK Developers**:
    - "Мои приложения" на https://vk.com/dev
    - Нажать на "Создать приложение"
    - Указать название приложения и выбрать платформу "Веб-сайт"
    - Ввести базовый домен сайта: `example.ru`
    - В поле "Доверенный redirect URI" ввести: `https://keycloak.host/realms/afe/broker/vkontakte/endpoint`
    - "Создать приложение"
    - После создания сохранить ID приложения и Защищенный ключ (Secret)

### На стороне Keycloak:
1. **Настройка Identity Provider**:
    - Войти в административную консоль Keycloak
    - Выбрать нужный realm (например, "afe")
    - Перейти в раздел "Identity Providers"
    - Добавить новый провайдер "VKontakte"
    - Заполнить следующие поля:
        - **Client ID**: ID приложения из VK
        - **Client Secret**: Защищенный ключ из VK
        - **Default Scopes**: `email` 
        - **Redirect URI**: `https://keycloak.host/realms/afe/broker/vkontakte/endpoint` (это значение автоматически сформировано и должно совпадать с тем, что указано в VK)
    - Сохранить

2. **Настройка Client для фронтенда**:
    - В том же realm перейти в раздел "Clients"
    - Найти нужный клиент (afe_app)
    - Указать Valid Redirect URI: `http://localhost` (для разработки) 
    - Настроить другие необходимые параметры клиента
    - Сохранить

---

## ПРИНЦИП ВЗАИМОДЕЙСТВИЯ

1. **Фронтенд инициирует авторизацию**:
    - Фронтенд перенаправляет пользователя на Keycloak с параметром `kc_idp_hint=vkontakte`:
   ```
   https://keycloak.host/realms/afe/protocol/openid-connect/auth
   ?client_id=afe_app
   &redirect_uri=http://localhost
   &response_type=code
   &scope=email
   &kc_idp_hint=vkontakte
   ```
    - Параметр `kc_idp_hint=vkontakte` указывает Keycloak, что нужно использовать ВКонтакте для авторизации, минуя экран выбора провайдера

2. **Keycloak перенаправляет на ВКонтакте**:
    - Keycloak перенаправляет пользователя на страницу авторизации ВКонтакте:
   ```
   https://oauth.vk.com/authorize
   ?client_id=53472495
   &redirect_uri=https://keycloak.host/realms/afe/broker/vkontakte/endpoint
   &response_type=code
   &scope=email
   &v=5.131
   ```
    - Важно: `redirect_uri` в этом запросе должен точно совпадать с "Доверенным redirect URI" в настройках приложения ВКонтакте

3. **Проверка redirect_uri на стороне ВКонтакте**:
    - ВКонтакте проверяет, что полученный `redirect_uri` совпадает с доверенным URI в настройках приложения
    - Если значения не совпадают, ВКонтакте вернет ошибку: "Выбранный способ авторизации не доступен для приложения"
    - Если значения совпадают, пользователю отображается страница авторизации/разрешений ВКонтакте

4. **ВКонтакте перенаправляет на Keycloak**:
    - После успешной авторизации пользователя, ВКонтакте перенаправляет на указанный `redirect_uri` с кодом авторизации:
   ```
   https://keycloak.host/realms/afe/broker/vkontakte/endpoint?code=abc123
   ```
    - Важно: это именно перенаправление браузера, а не прямой запрос от серверов ВКонтакте к Keycloak

5. **Keycloak обменивает код на токены**:
    - Keycloak получает код авторизации и выполняет запрос к ВКонтакте для обмена кода на токены:
   ```
   POST https://oauth.vk.com/access_token
   Content-Type: application/x-www-form-urlencoded
   
   client_id=53472495
   &client_secret=секретный_ключ
   &redirect_uri=https://keycloak.host/realms/afe/broker/vkontakte/endpoint
   &code=abc123
   ```
    - ВКонтакте возвращает `access_token`, `user_id` и другие данные
    - Keycloak использует полученный токен для запроса дополнительной информации о пользователе через API ВКонтакте

6. **Keycloak создает/обновляет пользователя и перенаправляет на фронтенд**:
    - Keycloak создает или обновляет пользователя в своей БД на основе полученных данных
    - Keycloak генерирует собственный код авторизации и перенаправляет пользователя на фронтенд:
   ```
   http://localhost?code=keycloak_code_xyz
   ```

7. **Фронтенд обменивает код на токены**:
    - Фронтенд получает код и обменивает его на токены через backend -> keycloak:
    - Keycloak возвращает `access_token`, `refresh_token`, `id_token` и другие данные
    - Фронтенд сохраняет токены и использует их для аутентификации в дальнейшем

---

## ВАЖНЫЕ ПРИМЕЧАНИЯ

1. **Почему настройка redirect_uri критически важна**:
    - Если в запросе авторизации указан redirect_uri, не совпадающий с тем, что указан в настройках приложения, авторизация будет отклонена
    - Он должен быть с валидным сертификатом SSL и доменом (для примера написал keycloak.host)




